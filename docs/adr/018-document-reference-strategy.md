# ADR-018: Document Reference Strategy

## Status

Accepted

## Context

Ukiyoueフレームワークでは、ドキュメント間の参照関係を表現し、セマンティック検証（SHACL）でその整合性を検証する必要があります。

**要求事項**:

- ✅ ドキュメントの一意識別（各ドキュメントが一意のIRIで識別される）
- ✅ 参照関係の表現（ドキュメント間の依存関係・関連を明示的に表現）
- ✅ 参照先の検証（参照先ドキュメントの存在確認）
- ✅ RDF変換の正確性（JSON-LD → RDF変換時に参照関係が正しく表現される）
- ✅ SHACL検証の実行（複数ドキュメントを統合したRDFグラフに対して検証）

**制約条件**:

- ユーザビリティ：開発者がドキュメントを作成・編集しやすい
- ポータビリティ：プロジェクトの移動・共有が容易
- セマンティック標準：JSON-LD/RDF/SHACL標準に準拠
- 検証の確実性：参照エラーを確実に検出できる

**技術的課題**:

JSON Pointerの限界:

```json
{
  "id": "FR-001",
  "testCases": ["TC-001", "TC-002"] // ← 単なる文字列、参照関係が不明確
}
```

JSON Pointerは同一ドキュメント内の参照を想定しており、外部ドキュメントへの参照を表現できません。RDF変換時に参照関係が失われる問題があります。

複数ドキュメントの検証における課題：

- どのドキュメントをいつ読み込むべきか
- 循環参照の検出方法
- 参照先が見つからない場合の処理

## Decision

**相対パス + ベースIRI方式**を採用します。

プロジェクト設定でベースIRIを定義し、ドキュメントでは相対パスを使用することで、ユーザビリティとセマンティック正確性の両立を図ります。

## Options Considered

### Option A: 完全IRI方式

**概要**: 各ドキュメントに完全なHTTP URLを割り当て、参照も完全IRIで行う。

```json
{
  "@id": "https://example.com/docs/requirements/FR-001",
  "testCases": [{ "@id": "https://example.com/docs/tests/TC-001" }]
}
```

**Pros**:

- ✅ セマンティック的に完璧
- ✅ RDF変換が直接的
- ✅ 標準的なJSON-LDの使い方

**Cons**:

- ❌ ユーザビリティが低い（IRIが長く冗長）
- ❌ ポータビリティが低い（プロジェクト移動時にすべてのIRIを書き換え）
- ❌ 編集が煩雑

### Option B: 相対パス + ベースIRI方式（採用）

**概要**: プロジェクト設定でベースIRIを定義し、ドキュメントでは相対パスを使用。

```json
{
  "@id": "requirements/FR-001",
  "testCases": [{ "@id": "tests/TC-001" }]
}
```

**Pros**:

- ✅ ユーザビリティが高い（短く簡潔）
- ✅ ポータビリティが高い（ベースIRIのみ変更）
- ✅ 編集が容易
- ✅ セマンティック検証可能（解決後は完全IRI）

**Cons**:

- ⚠️ IRI解決ステップが必要（実装の複雑さが若干増加）

### Option C: ローカルID参照 + マッピング

**概要**: ローカルID（文字列）で参照し、フレームワークがIRIにマッピング。

```json
{
  "id": "FR-001",
  "testCases": ["TC-001", "TC-002"]
}
```

**Pros**:

- ✅ ユーザビリティが非常に高い

**Cons**:

- ❌ セマンティック的に不明確
- ❌ JSON-LD標準から逸脱
- ❌ マッピングロジックが複雑
- ❌ RDF変換時の信頼性が低い

## Comparison Matrix

| 評価基準                 | 重み | Option A: 完全IRI | Option B: 相対パス | Option C: ローカルID |
| ------------------------ | ---- | ----------------- | ------------------ | -------------------- |
| **セマンティック正確性** | 5    | 5                 | 5                  | 2                    |
| **ユーザビリティ**       | 4    | 2                 | 5                  | 5                    |
| **ポータビリティ**       | 4    | 1                 | 5                  | 4                    |
| **実装の複雑さ**         | 3    | 5                 | 4                  | 2                    |
| **標準準拠**             | 3    | 5                 | 5                  | 2                    |
| **RDF変換の信頼性**      | 3    | 5                 | 5                  | 3                    |
| **合計**                 | -    | **85**            | **105**            | **62**               |
| **正規化スコア（/30）**  | -    | **23.2**          | **28.6**           | **16.9**             |

**重み付け理由**:

- **セマンティック正確性（5）**: RDF/SHACL検証の正確性は最優先
- **ユーザビリティ（4）**: 開発者の生産性に直結
- **ポータビリティ（4）**: プロジェクト共有・移行の容易さ
- **実装の複雑さ（3）**: フレームワークの保守性に影響
- **標準準拠（3）**: JSON-LD/RDF標準への適合度
- **RDF変換の信頼性（3）**: セマンティック検証の前提条件

## Consequences

### Positive

- ✅ **ユーザーフレンドリー**: ドキュメント作成者は短い相対パスのみ記述
- ✅ **ポータビリティ**: プロジェクト移動時はベースIRIのみ変更
- ✅ **セマンティック完全性**: IRI解決後は完全なIRIとなり、RDF/SHACL検証が正確に機能
- ✅ **標準準拠**: JSON-LD/RDF/SHACL標準に完全準拠
- ✅ **拡張性**: 将来的に外部IRI（他プロジェクトへの参照）も混在可能

### Negative

- ⚠️ IRI解決ステップが必要（実装の複雑さが若干増加）
- ⚠️ 処理オーバーヘッド（検証前にすべてのドキュメントを読み込み・解決）
- ⚠️ デバッグ時の理解（相対IRIと絶対IRIの対応関係）

### Mitigation

- **実装の複雑さ**: IriResolverクラスとして独立実装、テストカバレッジ100%
- **処理オーバーヘッド**: キャッシュ機構の導入、並列読み込み
- **デバッグの難しさ**: CLIツールでIRI解決結果を表示する機能を提供

## Implementation Notes

```yaml
Phase 1 (PoC) - 必須実装: IriResolver クラス（相対→絶対IRI変換）
  SemanticEngine.buildRdfDataset()（複数ドキュメント統合）
  SemanticEngine.validateReferences()（参照先存在確認）
  プロジェクト設定の読み込み（baseIri取得）

Phase 1 - テストケース: 相対IRI解決の正確性テスト
  複数ドキュメントのRDF統合テスト
  参照エラーの検出テスト
  循環参照の検出テスト

Phase 2以降 - 最適化: ドキュメントキャッシュ（変更検知）
  増分RDF構築（変更分のみ）
  並列読み込み・処理

Phase 2以降 - 機能拡張: 外部プロジェクトへの参照（異なるbaseIri）
  IRI別名（alias）機能
  IRIマッピングのインポート/エクスポート
```

### 成功基準

- [ ] 相対IRIが正しく絶対IRIに解決される
- [ ] 複数ドキュメントが単一のRDFグラフに統合される
- [ ] SHACL検証で参照整合性が検証される
- [ ] 参照先が存在しない場合にエラーが報告される
- [ ] 循環参照が検出される
- [ ] 10ドキュメントの検証が2秒以内（Phase 1目標）

### リスクと軽減策

| リスク             | 影響度 | 発生確率 | 軽減策                                    |
| ------------------ | ------ | -------- | ----------------------------------------- |
| IRI解決の実装ミス  | 高     | 中       | 豊富なテストケース、URL標準ライブラリ使用 |
| パフォーマンス劣化 | 中     | 高       | キャッシュ導入、段階的読み込み            |
| 循環参照の未検出   | 中     | 低       | 深さ優先探索による検出ロジック            |
| 相対パスの誤解     | 低     | 中       | ドキュメント充実、エラーメッセージ改善    |

## Based on

- ADR-003: Semantic Definition
- ADR-005: Element Identification
- ADR-006: Semantic Integrity Validation
- ADR-011: JSON-LD Library
