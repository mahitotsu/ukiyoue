# ADR-003: JSON-LD バージョンの選定

## Status

**承認済み** (Accepted)

## Context

### Background

ADR-001 で JSON-LD をセマンティック定義に使用することが決定した。JSON-LD には 2 つのメジャーバージョンが存在し、どちらを採用するかを決定する必要がある。

### Requirements

この決定は、specs/requirements.md より以下のフレームワーク要件に直接影響する：

| 要件 ID          | 要件名                   | 関連性                                   |
| ---------------- | ------------------------ | ---------------------------------------- |
| **FR-CONV-001**  | セマンティック検索       | 🔴 Critical - 意味定義の表現力に直接影響 |
| **FR-REUSE-002** | セマンティック検索と推奨 | 🟡 High - 知識グラフ構築の基盤           |
| **FR-CONV-002**  | 動的な情報再構成         | 🟡 High - セマンティック情報に基づく変換 |

### Decision Criteria

| 基準               | 説明                           | 重要度      |
| ------------------ | ------------------------------ | ----------- |
| **機能性**         | 必要なセマンティック機能の充実 | 🔴 Critical |
| **標準化**         | W3C 勧告としての地位           | 🔴 Critical |
| **ツールサポート** | JSON-LD プロセッサの対応状況   | 🟡 High     |
| **後方互換性**     | 既存データとの互換性           | 🟡 High     |
| **将来性**         | 長期的なサポート見込み         | 🟢 Medium   |

## Options

### Option 1: JSON-LD 1.0

#### Description

- **リリース**: 2014年
- **仕様**: W3C Recommendation (2014年1月)
- **状態**: 初版、広く普及

#### Pros

- ✅ **安定性**: 10年以上の実績
- ✅ **ツールサポート**: jsonld.js, PyLD など主要ライブラリが対応
- ✅ **情報量**: ドキュメント、事例が豊富
- ✅ **互換性**: 既存 JSON-LD データとの完全互換

#### Cons

- ❌ **機能制限**: Nested context, @protected, @import などが未サポート
- ❌ **Context 管理**: グローバル context のみで、スコープ管理が困難
- ❌ **型安全性**: @json 型がなく、JSON リテラルの扱いが限定的
- ❌ **拡張性**: 複雑なセマンティック定義に対応しにくい

### Option 2: JSON-LD 1.1

#### Description

- **リリース**: 2020年
- **仕様**: W3C Recommendation (2020年7月)
- **状態**: 最新勧告、1.0 の後継

#### Pros

- ✅ **Nested Context**: context をネストでき、スコープ管理が容易
- ✅ **@protected**: context の上書きを防止し、意味の一貫性を保証
- ✅ **@import**: 外部 context の再利用が可能
- ✅ **@json 型**: JSON リテラルを型安全に扱える
- ✅ **@propagate**: context の伝播制御が可能
- ✅ **W3C 勧告**: 正式な標準仕様
- ✅ **後方互換**: JSON-LD 1.0 データをそのまま処理可能
- ✅ **ツール対応**: jsonld.js 5+, PyLD 2+ で完全サポート

#### Cons

- ❌ **学習コスト**: 1.0 より機能が多く、習得に時間がかかる
- ❌ **複雑性**: Nested context や @propagate は誤用すると混乱を招く
- ❌ **情報量**: 1.0 より事例・ドキュメントが少ない（ただし増加中）

## Decision

### 選定結果

Option 2 (JSON-LD 1.1) を採用する

### Rationale

Decision Criteria の Critical 項目（機能性、標準化）を最も満たすのは JSON-LD 1.1：

1. **機能性** (Critical): Nested context, @protected, @import により、複雑なセマンティック定義が可能
2. **標準化** (Critical): W3C 正式勧告（2020年7月）として承認済み

JSON-LD 1.0 は安定性があるが、Context で示した要件（FR-CONV-001: セマンティック検索）を実現するには、Nested context や @protected による厳密な意味定義が必要。特に、Ukiyoue フレームワークでは複数のドキュメントタイプを扱うため、context のスコープ管理（Nested context）と意味の保護（@protected）が重要。

また、JSON-LD 1.1 は後方互換性があり、1.0 のデータをそのまま処理可能。ツールサポートも主要ライブラリ（jsonld.js 5+, PyLD 2+）で完全対応済み。

W3C 勧告として正式に承認されており、長期的なサポートが期待できる点も決定の要因。

### JSON-LD の主要用途

JSON-LD 1.1 の採用により、以下の機能が実現可能になる：

1. **セマンティック検索** (FR-CONV-001)
   - JSON-LD → RDF 変換により、SPARQL クエリでの検索が可能
   - 例: "特定の Business Goal に関連するすべての成果物を取得"

2. **SHACL による検証** (FR-AUTO-002)
   - RDF グラフに対して SHACL 制約を適用
   - グラフパターンの検証、トレーサビリティの完全性確認
   - 詳細は ADR-008 を参照

3. **AI 自動提案機能** (FR-REUSE-002)
   - RDF グラフからトレーサビリティパスを抽出
   - 影響範囲分析、欠けている成果物の提案
   - セマンティック推論に基づく自動補完

4. **動的な情報再構成** (FR-CONV-002)
   - @context の切り替えによる多様な表現形式
   - ビューに応じた情報の再構成

## Consequences

### Positive

- ✅ **強力なセマンティック表現**: Nested context により、ドキュメントタイプごとに適切な意味を定義可能
- ✅ **意味の一貫性**: @protected により、意図しない context 上書きを防止
- ✅ **再利用性向上**: @import により、共通 context を効率的に管理
- ✅ **型安全性**: @json 型により、JSON データを厳密に扱える
- ✅ **W3C 標準**: 正式勧告として長期サポートが期待できる
- ✅ **後方互換**: JSON-LD 1.0 データも処理可能

### Negative

- ❌ **学習コスト**: 新機能の理解に時間が必要
- ❌ **複雑性リスク**: Nested context や @propagate の誤用で混乱する可能性
- ❌ **情報量不足**: 1.0 より事例が少ない（ただし増加傾向）

### Risks

- ⚠️ **過度な複雑化**: Nested context を多用すると、かえって理解が困難になる
- ⚠️ **ツールバグ**: 比較的新しい仕様のため、エッジケースで不具合の可能性

### Mitigation

- 💡 **段階的導入**: 初期は基本機能のみ使用し、徐々に高度な機能を導入
- 💡 **ベストプラクティス策定**: Nested context, @protected の使用ガイドラインを作成
- 💡 **ツール選定**: 実績のある jsonld.js 5+ を使用し、バグリスクを低減
- 💡 **文書化**: context 設計をドキュメント化し、チーム内で共有

## Prerequisites

- ADR-001: データフォーマット・スキーマ定義・セマンティック定義の選定

## Related Decisions

- **ADR-008**: 多層検証戦略
  - JSON-LD → RDF 変換を SHACL 検証の基盤として活用
