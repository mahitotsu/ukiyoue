{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://ukiyoue.example.org/schemas/layer3/data-model.json",
  "title": "Data Model (Logical Data Model)",
  "description": "論理データモデル（ARCH-DATA）: システムが扱うデータの構造を論理的に定義（データストア非依存、実装可能な詳細レベル）",
  "allOf": [{ "$ref": "../_common.json#/definitions/baseArtifact" }],
  "type": "object",
  "required": ["title", "dataStoreType"],
  "properties": {
    "@type": {
      "const": "DataModel"
    },
    "title": {
      "type": "string",
      "description": "データモデルのタイトル",
      "minLength": 1
    },
    "overview": {
      "type": "string",
      "description": "データモデルの概要"
    },
    "dataStoreType": {
      "type": "string",
      "enum": [
        "relational",
        "document",
        "key-value",
        "graph",
        "column-family",
        "search-engine",
        "time-series",
        "message-queue"
      ],
      "description": "対象とするデータストアの種別"
    },
    "entities": {
      "type": "array",
      "description": "エンティティ/コレクション/ノード等のデータ構造（論理設計レベル）",
      "items": {
        "type": "object",
        "required": ["id", "name", "description"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^ENT-[A-Z]+-[0-9]{3}$",
            "description": "エンティティID（Conceptual Data Modelと同じIDを使用）"
          },
          "name": {
            "type": "string",
            "description": "エンティティ名（テーブル、コレクション、ノードラベル等）"
          },
          "description": {
            "type": "string",
            "description": "技術的な観点でのエンティティの役割"
          },
          "conceptualEntityReference": {
            "type": "string",
            "pattern": "^ENT-[A-Z]+-[0-9]{3}$",
            "description": "Layer 2の概念エンティティIDへの参照"
          },
          "attributes": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["name", "type"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "属性名（カラム、フィールド、プロパティ等）"
                },
                "type": {
                  "type": "string",
                  "description": "論理的な型（例: String, Integer, Timestamp, UUID, Boolean, Object, Array）"
                },
                "description": {
                  "type": "string",
                  "description": "属性の技術的な説明"
                },
                "required": {
                  "type": "boolean",
                  "description": "必須かどうか（NOT NULL相当）",
                  "default": false
                },
                "unique": {
                  "type": "boolean",
                  "description": "一意性制約",
                  "default": false
                },
                "isPrimaryKey": {
                  "type": "boolean",
                  "description": "主キー/識別子かどうか",
                  "default": false
                },
                "isIndexed": {
                  "type": "boolean",
                  "description": "インデックス対象かどうか",
                  "default": false
                },
                "defaultValue": {
                  "description": "デフォルト値（型に応じた値）"
                },
                "constraints": {
                  "type": "string",
                  "description": "制約条件の記述（データストア非依存の論理表現）"
                },
                "termReference": {
                  "type": "string",
                  "pattern": "^TERM-[A-Z]+-[0-9]{3}$",
                  "description": "Layer 2 Data Dictionaryの用語IDへの参照"
                }
              }
            },
            "description": "属性詳細定義（全属性を網羅）"
          },
          "relationships": {
            "type": "array",
            "items": {
              "type": "object",
              "required": ["type", "target"],
              "properties": {
                "type": {
                  "type": "string",
                  "enum": [
                    "one-to-one",
                    "one-to-many",
                    "many-to-one",
                    "many-to-many",
                    "embedded",
                    "referenced",
                    "edge"
                  ],
                  "description": "関係の種類（RDB: one-to-*, Document: embedded/referenced, Graph: edge）"
                },
                "target": {
                  "type": "string",
                  "pattern": "^ENT-[A-Z]+-[0-9]{3}$",
                  "description": "関連先エンティティID"
                },
                "cardinality": {
                  "type": "string",
                  "description": "多重度の詳細（例: 1..*, 0..1）"
                },
                "description": {
                  "type": "string",
                  "description": "関係の説明"
                },
                "relationshipReference": {
                  "type": "string",
                  "pattern": "^REL-[A-Z]+-[0-9]{3}$",
                  "description": "Layer 2 Conceptual Data Modelの関係IDへの参照"
                }
              }
            },
            "description": "リレーションシップ（データストア種別に応じた表現）"
          },
          "accessPatterns": {
            "type": "array",
            "description": "想定されるアクセスパターン（インデックス設計の根拠）",
            "items": {
              "type": "object",
              "required": ["name", "description"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "アクセスパターン名"
                },
                "description": {
                  "type": "string",
                  "description": "クエリパターンの詳細"
                },
                "frequency": {
                  "type": "string",
                  "enum": ["high", "medium", "low"],
                  "description": "アクセス頻度"
                },
                "attributes": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "アクセスに使用する属性"
                }
              }
            }
          },
          "indexes": {
            "type": "array",
            "description": "インデックス設計方針（物理実装はLayer 4）",
            "items": {
              "type": "object",
              "required": ["name", "attributes"],
              "properties": {
                "name": {
                  "type": "string",
                  "description": "インデックス名"
                },
                "attributes": {
                  "type": "array",
                  "items": { "type": "string" },
                  "description": "インデックス対象の属性"
                },
                "unique": {
                  "type": "boolean",
                  "description": "一意性制約",
                  "default": false
                },
                "rationale": {
                  "type": "string",
                  "description": "インデックスを作成する理由（どのアクセスパターンに対応するか）"
                }
              }
            }
          }
        }
      },
      "minItems": 1
    },
    "dataStoreSpecificDesign": {
      "type": "object",
      "description": "データストア種別固有の設計要素",
      "properties": {
        "normalization": {
          "type": "object",
          "description": "正規化設計（RDB向け）",
          "properties": {
            "level": {
              "type": "string",
              "enum": ["1NF", "2NF", "3NF", "BCNF", "4NF", "5NF"],
              "description": "正規化レベル"
            },
            "rationale": {
              "type": "string",
              "description": "正規化レベル選択の理由"
            },
            "denormalizationDecisions": {
              "type": "array",
              "description": "意図的な非正規化（パフォーマンス最適化等）",
              "items": {
                "type": "object",
                "properties": {
                  "entity": {
                    "type": "string",
                    "pattern": "^ENT-[A-Z]+-[0-9]{3}$",
                    "description": "非正規化を適用するエンティティID"
                  },
                  "reason": {
                    "type": "string",
                    "description": "非正規化の理由"
                  },
                  "tradeoff": {
                    "type": "string",
                    "description": "トレードオフ（更新コスト vs 参照性能等）"
                  }
                }
              }
            }
          }
        },
        "shardingStrategy": {
          "type": "object",
          "description": "シャーディング戦略（Document DB、Column Family等向け）",
          "properties": {
            "shardKey": {
              "type": "string",
              "description": "シャードキーとなる属性"
            },
            "rationale": {
              "type": "string",
              "description": "シャードキー選択の理由"
            }
          }
        },
        "partitioningStrategy": {
          "type": "object",
          "description": "パーティショニング戦略（メッセージキュー、時系列DB等向け）",
          "properties": {
            "partitionKey": {
              "type": "string",
              "description": "パーティションキーとなる属性"
            },
            "rationale": {
              "type": "string",
              "description": "パーティションキー選択の理由"
            }
          }
        },
        "graphDesign": {
          "type": "object",
          "description": "グラフ設計（Graph DB向け）",
          "properties": {
            "nodeLabels": {
              "type": "array",
              "items": { "type": "string" },
              "description": "ノードラベル一覧"
            },
            "relationshipTypes": {
              "type": "array",
              "items": { "type": "string" },
              "description": "リレーションシップタイプ一覧"
            }
          }
        }
      }
    },
    "domains": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["name", "type"],
        "properties": {
          "name": {
            "type": "string",
            "description": "ドメイン名（例: EmailAddress, PhoneNumber, Money）"
          },
          "type": {
            "type": "string",
            "description": "技術的な型定義"
          },
          "format": {
            "type": "string",
            "description": "フォーマット制約"
          },
          "validation": {
            "type": "string",
            "description": "バリデーションルール"
          },
          "termReference": {
            "type": "string",
            "pattern": "^TERM-[A-Z]+-[0-9]{3}$",
            "description": "Layer 2 Data Dictionaryの用語IDへの参照"
          }
        }
      },
      "description": "共通ドメイン定義（再利用可能な型）"
    },
    "integrityConstraints": {
      "type": "array",
      "description": "データ整合性制約",
      "items": {
        "type": "object",
        "required": ["type", "description"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["referential-integrity", "check-constraint", "trigger", "unique-constraint"],
            "description": "制約の種類"
          },
          "description": {
            "type": "string",
            "description": "制約の内容"
          },
          "affectedEntities": {
            "type": "array",
            "items": {
              "type": "string",
              "pattern": "^ENT-[A-Z]+-[0-9]{3}$"
            },
            "description": "影響を受けるエンティティ"
          },
          "businessRuleReference": {
            "type": "string",
            "pattern": "^BR-[A-Z]+-[0-9]{3}$",
            "description": "Layer 2 Conceptual Data Modelのビジネスルールへの参照"
          }
        }
      }
    }
  }
}
