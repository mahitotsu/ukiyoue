@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix ukiyoue: <https://ukiyoue.example.org/vocab#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

# ============================================================
# Layer 1: Business Context
# ============================================================

# Project Charter - Starting point (no inputs allowed)
ukiyoue:ProjectCharterShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:ProjectCharter ;
  sh:name "Project Charter Constraints" ;
  sh:description "Project Charter is a starting point artifact with no derivedFrom references" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:maxCount 0 ;
    sh:message "Project Charter must not have derivedFrom (it is a starting point)" ;
  ] .

# Roadmap - Derived from Project Charter
ukiyoue:RoadmapShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:Roadmap ;
  sh:name "Roadmap Constraints" ;
  sh:description "Roadmap must be derived from Project Charter" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:class ukiyoue:ProjectCharter ;
    sh:message "Roadmap must be derived from Project Charter" ;
  ] .

# Risk Register - No derivedFrom (uses affectedArtifacts per risk instead)
ukiyoue:RiskRegisterShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:RiskRegister ;
  sh:name "Risk Register Constraints" ;
  sh:description "Risk Register should not have derivedFrom; traceability via individual risk affectedArtifacts (validated by Reference Validator)" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:maxCount 0 ;
    sh:message "Risk Register should not have derivedFrom (use affectedArtifacts in each risk instead)" ;
  ] .
# Note: Individual risk.affectedArtifacts are validated by Reference Validator

# Business Goal - Derived from Project Charter
ukiyoue:BusinessGoalShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:BusinessGoal ;
  sh:name "Business Goal Constraints" ;
  sh:description "Business Goal must be derived from Project Charter and realized by at least one User Story" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:class ukiyoue:ProjectCharter ;
    sh:message "Business Goal must be derived from Project Charter" ;
  ] ;
  # Bidirectional traceability: Business Goal must be realized by at least one User Story
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:class ukiyoue:UserStory ;
    sh:minCount 1 ;
    sh:message "Business Goal must be realized by at least one User Story (reverse traceability check)" ;
  ] .

# User Story - Derived from Business Goal
ukiyoue:UserStoryShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:UserStory ;
  sh:name "User Story Constraints" ;
  sh:description "User Story must be derived from Business Goal and realized by at least one Use Case or Functional Requirements" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:class ukiyoue:BusinessGoal ;
    sh:message "User Story must be derived from Business Goal" ;
  ] ;
  # Bidirectional traceability: User Story must be realized by downstream artifacts
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:minCount 1 ;
    sh:message "User Story must be realized by at least one Use Case, Functional Requirements, or Non-Functional Requirements (reverse traceability check)" ;
  ] .

# ============================================================
# Layer 2: Requirements & Analysis
# ============================================================

# Use Case - Derived from User Story and/or Business Goal
ukiyoue:UseCaseShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:UseCase ;
  sh:name "Use Case Constraints" ;
  sh:description "Use Case must be derived from User Story and/or Business Goal and realized by at least one Functional Requirements" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:UserStory ]
      [ sh:class ukiyoue:BusinessGoal ]
    ) ;
    sh:message "Use Case must be derived from User Story or Business Goal" ;
  ] ;
  # Bidirectional traceability: Use Case must be realized by downstream artifacts
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:minCount 1 ;
    sh:message "Use Case must be realized by at least one Functional Requirements (reverse traceability check)" ;
  ] .

# Functional Requirements - Derived from Use Case and/or Business Goal
ukiyoue:FunctionalRequirementsShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:FunctionalRequirements ;
  sh:name "Functional Requirements Constraints" ;
  sh:description "Functional Requirements must be derived from Use Case and/or Business Goal and realized by downstream architecture artifacts" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:UseCase ]
      [ sh:class ukiyoue:BusinessGoal ]
    ) ;
    sh:message "Functional Requirements must be derived from Use Case or Business Goal" ;
  ] ;
  # Bidirectional traceability: Functional Requirements must be realized by downstream artifacts
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:minCount 1 ;
    sh:message "Functional Requirements must be realized by at least one Architecture artifact (Runtime/API), API Specification, or Test Strategy (reverse traceability check)" ;
  ] .

# Non-Functional Requirements - Derived from Business Goal and/or User Story
ukiyoue:NonFunctionalRequirementsShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:NonFunctionalRequirements ;
  sh:name "Non-Functional Requirements Constraints" ;
  sh:description "Non-Functional Requirements must be derived from Business Goal and/or User Story and realized by downstream architecture artifacts" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:BusinessGoal ]
      [ sh:class ukiyoue:UserStory ]
    ) ;
    sh:message "Non-Functional Requirements must be derived from Business Goal or User Story" ;
  ] ;
  # Bidirectional traceability: Non-Functional Requirements must be realized by downstream artifacts
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:minCount 1 ;
    sh:message "Non-Functional Requirements must be realized by at least one Architecture artifact (Reliability/Infrastructure/Security/etc.) or Test Strategy (reverse traceability check)" ;
  ] .

# Data Dictionary - Terms from User Story and/or Use Case
ukiyoue:DataDictionaryShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:DataDictionary ;
  sh:name "Data Dictionary Constraints" ;
  sh:description "Data Dictionary must be derived from User Story and/or Use Case and realized by Conceptual Data Model" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:UserStory ]
      [ sh:class ukiyoue:UseCase ]
    ) ;
    sh:message "Data Dictionary must be derived from User Story or Use Case" ;
  ] ;
  # Bidirectional traceability: Data Dictionary must be realized by Conceptual Data Model
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:class ukiyoue:ConceptualDataModel ;
    sh:minCount 1 ;
    sh:message "Data Dictionary must be realized by at least one Conceptual Data Model (reverse traceability check)" ;
  ] .

# Conceptual Data Model - Entities from Data Dictionary and/or Use Case
ukiyoue:ConceptualDataModelShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:ConceptualDataModel ;
  sh:name "Conceptual Data Model Constraints" ;
  sh:description "Conceptual Data Model must be derived from Data Dictionary and/or Use Case and realized by Logical Data Model" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:DataDictionary ]
      [ sh:class ukiyoue:UseCase ]
    ) ;
    sh:message "Conceptual Data Model must be derived from Data Dictionary or Use Case" ;
  ] ;
  # Bidirectional traceability: Conceptual Data Model must be realized by Logical Data Model
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:class ukiyoue:DataModel ;
    sh:minCount 1 ;
    sh:message "Conceptual Data Model must be realized by at least one Data Model (Logical) (reverse traceability check)" ;
  ] .

# Test Strategy - Derived from Functional Requirements and/or Non-Functional Requirements
ukiyoue:TestStrategyShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:TestStrategy ;
  sh:name "Test Strategy Constraints" ;
  sh:description "Test Strategy must be derived from Functional and/or Non-Functional Requirements and realized by Test Plan" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:FunctionalRequirements ]
      [ sh:class ukiyoue:NonFunctionalRequirements ]
    ) ;
    sh:message "Test Strategy must be derived from Functional or Non-Functional Requirements" ;
  ] ;
  # Bidirectional traceability: Test Strategy must be realized by Test Plan
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:class ukiyoue:TestPlan ;
    sh:minCount 1 ;
    sh:message "Test Strategy must be realized by at least one Test Plan (reverse traceability check)" ;
  ] .

# ============================================================
# Layer 3: Architecture & Design
# ============================================================

# Architecture Decision Record - No derivedFrom (uses impact and relatedDecisions instead)
ukiyoue:ArchitectureDecisionRecordShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:ArchitectureDecisionRecord ;
  sh:name "ADR Constraints" ;
  sh:description "ADR should not have derivedFrom; use impact and relatedDecisions fields instead (validated by Reference Validator)" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:maxCount 0 ;
    sh:message "ADR should not have derivedFrom (use impact and relatedDecisions instead)" ;
  ] .
# Note: ADR.relatedDecisions are validated by Reference Validator

# Runtime Architecture - Derived from FR, NFR, and/or ADR
ukiyoue:RuntimeArchitectureShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:RuntimeArchitecture ;
  sh:name "Runtime Architecture Constraints" ;
  sh:description "Runtime Architecture must be derived from FR, NFR, and/or ADR" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:FunctionalRequirements ]
      [ sh:class ukiyoue:NonFunctionalRequirements ]
      [ sh:class ukiyoue:ArchitectureDecisionRecord ]
    ) ;
    sh:message "Runtime Architecture must be derived from FR, NFR, or ADR" ;
  ] .

# Reliability Architecture - Derived from NFR and/or ADR
ukiyoue:ReliabilityArchitectureShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:ReliabilityArchitecture ;
  sh:name "Reliability Architecture Constraints" ;
  sh:description "Reliability Architecture must be derived from NFR and/or ADR" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:NonFunctionalRequirements ]
      [ sh:class ukiyoue:ArchitectureDecisionRecord ]
    ) ;
    sh:message "Reliability Architecture must be derived from NFR or ADR" ;
  ] .

# Infrastructure Architecture - Derived from NFR and/or ADR
ukiyoue:InfrastructureArchitectureShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:InfrastructureArchitecture ;
  sh:name "Infrastructure Architecture Constraints" ;
  sh:description "Infrastructure Architecture must be derived from NFR and/or ADR" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:NonFunctionalRequirements ]
      [ sh:class ukiyoue:ArchitectureDecisionRecord ]
    ) ;
    sh:message "Infrastructure Architecture must be derived from NFR or ADR" ;
  ] .

# Observability Architecture - Derived from NFR and/or ADR
ukiyoue:ObservabilityArchitectureShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:ObservabilityArchitecture ;
  sh:name "Observability Architecture Constraints" ;
  sh:description "Observability Architecture must be derived from NFR and/or ADR" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:NonFunctionalRequirements ]
      [ sh:class ukiyoue:ArchitectureDecisionRecord ]
    ) ;
    sh:message "Observability Architecture must be derived from NFR or ADR" ;
  ] .

# Security Architecture - Derived from NFR and/or ADR
ukiyoue:SecurityArchitectureShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:SecurityArchitecture ;
  sh:name "Security Architecture Constraints" ;
  sh:description "Security Architecture must be derived from NFR and/or ADR" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:NonFunctionalRequirements ]
      [ sh:class ukiyoue:ArchitectureDecisionRecord ]
    ) ;
    sh:message "Security Architecture must be derived from NFR or ADR" ;
  ] .

# DevOps Architecture - Derived from NFR and/or ADR
ukiyoue:DevOpsArchitectureShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:DevOpsArchitecture ;
  sh:name "DevOps Architecture Constraints" ;
  sh:description "DevOps Architecture must be derived from NFR and/or ADR" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:NonFunctionalRequirements ]
      [ sh:class ukiyoue:ArchitectureDecisionRecord ]
    ) ;
    sh:message "DevOps Architecture must be derived from NFR or ADR" ;
  ] .

# Development Environment Architecture - Derived from NFR and/or ADR
ukiyoue:DevelopmentEnvironmentArchitectureShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:DevelopmentEnvironmentArchitecture ;
  sh:name "Development Environment Architecture Constraints" ;
  sh:description "Development Environment Architecture must be derived from NFR and/or ADR" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:NonFunctionalRequirements ]
      [ sh:class ukiyoue:ArchitectureDecisionRecord ]
    ) ;
    sh:message "Development Environment Architecture must be derived from NFR or ADR" ;
  ] .

# API Architecture - Derived from FR, NFR, and/or ADR
ukiyoue:APIArchitectureShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:APIArchitecture ;
  sh:name "API Architecture Constraints" ;
  sh:description "API Architecture must be derived from FR, NFR, and/or ADR" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:FunctionalRequirements ]
      [ sh:class ukiyoue:NonFunctionalRequirements ]
      [ sh:class ukiyoue:ArchitectureDecisionRecord ]
    ) ;
    sh:message "API Architecture must be derived from FR, NFR, or ADR" ;
  ] .

# API Specification - Derived from Functional Requirements and/or API Architecture
ukiyoue:APISpecificationShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:APISpecification ;
  sh:name "API Specification Constraints" ;
  sh:description "API Specification must be derived from FR and/or API Architecture" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:FunctionalRequirements ]
      [ sh:class ukiyoue:APIArchitecture ]
    ) ;
    sh:message "API Specification must be derived from Functional Requirements or API Architecture" ;
  ] .

# Data Model (Logical) - Derived from Conceptual Data Model and/or Runtime Architecture
ukiyoue:DataModelShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:DataModel ;
  sh:name "Data Model Constraints" ;
  sh:description "Data Model (Logical) must be derived from Conceptual Data Model and/or Runtime Architecture" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:or (
      [ sh:class ukiyoue:ConceptualDataModel ]
      [ sh:class ukiyoue:RuntimeArchitecture ]
    ) ;
    sh:message "Data Model must be derived from Conceptual Data Model or Runtime Architecture" ;
  ] .

# Test Plan - Derived from Test Strategy
ukiyoue:TestPlanShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:TestPlan ;
  sh:name "Test Plan Constraints" ;
  sh:description "Test Plan must be derived from Test Strategy and realized by Test Specification" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:class ukiyoue:TestStrategy ;
    sh:message "Test Plan must be derived from Test Strategy" ;
  ] ;
  # Bidirectional traceability: Test Plan must be realized by Test Specification
  sh:property [
    sh:path [ sh:inversePath ukiyoue:derivedFrom ] ;
    sh:class ukiyoue:TestSpecification ;
    sh:minCount 1 ;
    sh:message "Test Plan must be realized by at least one Test Specification (reverse traceability check)" ;
  ] .

# Test Specification - Derived from Test Plan
ukiyoue:TestSpecificationShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:TestSpecification ;
  sh:name "Test Specification Constraints" ;
  sh:description "Test Specification must be derived from Test Plan" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:class ukiyoue:TestPlan ;
    sh:message "Test Specification must be derived from Test Plan" ;
  ] .

# UI/UX Specification - Derived from Functional Requirements
ukiyoue:UIUXSpecificationShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:UIUXSpecification ;
  sh:name "UI/UX Specification Constraints" ;
  sh:description "UI/UX Specification must be derived from Functional Requirements" ;
  sh:property [
    sh:path ukiyoue:derivedFrom ;
    sh:minCount 1 ;
    sh:class ukiyoue:FunctionalRequirements ;
    sh:message "UI/UX Specification must be derived from Functional Requirements" ;
  ] .

# ============================================================
# Additional Common Constraints
# ============================================================

# All artifacts must have an id
ukiyoue:ArtifactIdShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:Artifact ;
  sh:property [
    sh:path ukiyoue:id ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:datatype xsd:string ;
    sh:pattern "^[a-z0-9-]+$" ;
    sh:message "All artifacts must have a lowercase alphanumeric id" ;
  ] .

# All artifacts must have a title
ukiyoue:ArtifactTitleShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:Artifact ;
  sh:property [
    sh:path ukiyoue:title ;
    sh:minCount 1 ;
    sh:maxCount 1 ;
    sh:datatype xsd:string ;
    sh:minLength 1 ;
    sh:message "All artifacts must have a non-empty title" ;
  ] .

# All artifacts must have a type
ukiyoue:ArtifactTypeShape
  a sh:NodeShape ;
  sh:targetClass ukiyoue:Artifact ;
  sh:property [
    sh:path rdf:type ;
    sh:minCount 1 ;
    sh:message "All artifacts must have a type" ;
  ] .
